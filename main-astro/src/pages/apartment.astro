---
import Layout from "../layouts/Layout.astro";
import { Building2, Droplets, ShieldCheck, ArrowRight, Users, User } from "@lucide/astro";
---

<Layout title="Rent Affordability" themeColor="bg-indigo-50">
  <main class="md:ml-24 p-4 lg:p-8 max-w-[1200px] mx-auto pb-32">
    
    <header class="bg-white/80 backdrop-blur-md rounded-[2.5rem] p-8 mb-8 border border-white shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="flex items-center gap-4 text-indigo-600">
        <div class="p-4 bg-indigo-600 text-white rounded-2xl shadow-lg shadow-indigo-200">
          <Building2 size={32} />
        </div>
        <div>
          <h1 class="text-3xl font-black text-slate-900 tracking-tight">Rent Hub</h1>
          <p class="text-slate-500 font-medium">Split bills & check affordability</p>
        </div>
      </div>
      <div class="text-center md:text-right">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Your Monthly Share</p>
        <p id="display-your-share" class="text-4xl font-black text-indigo-600">$0</p>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <section class="space-y-6">

        <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
          <div class="space-y-4">
            <div>
              <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Total Monthly Rent</label>
              <input type="number" id="input-rent" placeholder="2400" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-lg border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all" />
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Total Utilities</label>
                <input type="number" id="input-utils" placeholder="200" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all" />
              </div>
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Your Insurance</label>
                <input type="number" id="input-renters-ins" placeholder="20" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold border-2 border-transparent focus:border-indigo-500 focus:bg-white transition-all" />
              </div>
            </div>
          </div>
        </div>

        <div class="bg-indigo-600 rounded-[2.5rem] p-6 text-white shadow-xl shadow-indigo-100">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <Users size={24} />
                    <h2 class="font-black text-lg">Split with Roommates?</h2>
                </div>
                <div class="flex items-center bg-white/20 p-1 rounded-xl border border-white/20">
                    <button id="roommate-dec" class="w-10 h-10 flex items-center justify-center font-bold hover:bg-white/20 rounded-lg transition-all">-</button>
                    <span id="roommate-count" class="w-10 text-center font-black text-xl">1</span>
                    <button id="roommate-inc" class="w-10 h-10 flex items-center justify-center font-bold hover:bg-white/20 rounded-lg transition-all">+</button>
                </div>
            </div>
            <p class="text-indigo-100 text-xs mt-3 font-medium">Total costs will be divided equally between <span id="roommate-label">1 person</span>.</p>
        </div>

        <button id="btn-push-rent" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] font-black text-lg hover:bg-indigo-600 transition-all flex items-center justify-center gap-3 group shadow-xl">
          Push Share to Budget <ArrowRight class="group-hover:translate-x-2 transition-transform" />
        </button>
      </section>

      <section class="space-y-6">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">Affordability Breakdown</h2>
            
            <div id="afford-card" class="p-8 rounded-[2rem] border-2 border-slate-100 bg-slate-50 transition-all duration-500">
                <div class="flex justify-between items-center mb-6">
                    <span id="afford-status" class="font-black text-xl uppercase tracking-tight text-slate-400">Enter Details</span>
                    <span id="afford-percent" class="bg-white px-3 py-1 rounded-full text-xs font-black shadow-sm">0%</span>
                </div>
                
                <div class="space-y-4">
                    <div class="flex justify-between text-sm font-bold">
                        <span class="text-slate-400">Total Building Cost</span>
                        <span id="total-building-cost" class="text-slate-900">$0</span>
                    </div>
                    <div class="flex justify-between text-sm font-bold border-t border-slate-200 pt-4">
                        <span class="text-slate-400">Your Share</span>
                        <span id="your-share-cost" class="text-indigo-600">$0</span>
                    </div>
                </div>

                <div class="mt-8">
                    <div class="w-full bg-slate-200 h-3 rounded-full overflow-hidden">
                        <div id="afford-bar" class="bg-indigo-500 h-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  import { sync_app, app_data, init_data } from "../utils/financial-data";

  function setupApartment() {
    init_data();

    // 1. SELECT ELEMENTS WITH TYPE HINTS
    /** @type {HTMLInputElement} */
    const rentIn = document.getElementById('input-rent');
    /** @type {HTMLInputElement} */
    const utilsIn = document.getElementById('input-utils');
    /** @type {HTMLInputElement} */
    const insIn = document.getElementById('input-renters-ins');
    
    const roommateCountDisplay = document.getElementById('roommate-count');
    const roommateLabel = document.getElementById('roommate-label');
    const displayShare = document.getElementById('display-your-share');
    const totalBuildingLabel = document.getElementById('total-building-cost');
    const yourShareLabel = document.getElementById('your-share-cost');
    const affordBar = document.getElementById('afford-bar');
    const affordStatus = document.getElementById('afford-status');
    const affordPercent = document.getElementById('afford-percent');
    const affordCard = document.getElementById('afford-card');
    const pushBtn = document.getElementById('btn-push-rent');

    let roommates = app_data.apartment.roommates || 1;

    function calculate() {
      const rent = parseFloat(rentIn?.value || "0");
      const utils = parseFloat(utilsIn?.value || "0");
      const ins = parseFloat(insIn?.value || "0"); // Insurance usually not split
      
      const totalBuilding = rent + utils;
      const yourShare = (totalBuilding / roommates) + ins;

      // Update UI
      if (displayShare) displayShare.innerText = `$${Math.round(yourShare).toLocaleString()}`;
      if (totalBuildingLabel) totalBuildingLabel.innerText = `$${Math.round(totalBuilding).toLocaleString()}`;
      if (yourShareLabel) yourShareLabel.innerText = `$${Math.round(yourShare).toLocaleString()}`;
      
      // Affordability Logic
      const monthlyNet = app_data.budget.net_income || 0;
      if (monthlyNet > 0 && yourShare > 0) {
        const percentage = (yourShare / monthlyNet) * 100;
        if (affordPercent) affordPercent.innerText = `${Math.round(percentage)}% of Net`;
        if (affordBar) affordBar.style.width = `${Math.min(percentage, 100)}%`;

        if (percentage <= 30) {
            updateUI("Affordable", "bg-emerald-50", "border-emerald-200", "text-emerald-600");
        } else if (percentage <= 45) {
            updateUI("Stretch", "bg-amber-50", "border-amber-200", "text-amber-600");
        } else {
            updateUI("Aggressive", "bg-rose-50", "border-rose-200", "text-rose-600");
        }
      }

      // Save to state
      app_data.apartment.roommates = roommates;
      app_data.apartment.your_share = Math.round(yourShare);
    }

    function updateUI(status, bg, border, text) {
        if (affordStatus) {
            affordStatus.innerText = status;
            affordStatus.className = `font-black text-xl uppercase tracking-tight ${text}`;
        }
        if (affordCard) affordCard.className = `p-8 rounded-[2rem] border-2 transition-all duration-500 ${bg} ${border}`;
    }

    // Roommate Controls
    document.getElementById('roommate-inc')?.addEventListener('click', () => {
        roommates++;
        updateRoommateUI();
    });
    document.getElementById('roommate-dec')?.addEventListener('click', () => {
        if (roommates > 1) {
            roommates--;
            updateRoommateUI();
        }
    });

    function updateRoommateUI() {
        if (roommateCountDisplay) roommateCountDisplay.innerText = roommates;
        if (roommateLabel) roommateLabel.innerText = roommates === 1 ? "1 person" : `${roommates} people`;
        calculate();
    }

    [rentIn, utilsIn, insIn].forEach(input => input?.addEventListener('input', calculate));

    // Push to Budget
    pushBtn?.addEventListener('click', () => {
        const share = app_data.apartment.your_share;
        const currentNeeds = Array.isArray(app_data.budget.needs) ? app_data.budget.needs : [];
        
        // Remove old Rent/Apartment tags
        const otherNeeds = currentNeeds.filter(item => item.name !== "Rent" && item.name !== "Apartment");
        const updatedNeeds = [...otherNeeds, { name: "Rent", amount: share }];
        
        app_data.budget.needs = updatedNeeds;
        sync_app('budget.needs', updatedNeeds);

        if (pushBtn) {
            pushBtn.innerText = "âœ“ Share Added to Budget";
            setTimeout(() => pushBtn.innerText = "Push Share to Budget", 2000);
        }
    });

    updateRoommateUI(); // Initial run
  }

  setupApartment();
  document.addEventListener('astro:page-load', setupApartment);
</script>