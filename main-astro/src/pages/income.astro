---
import Layout from "../layouts/Layout.astro";
import { Banknote, TrendingUp, Wallet, ReceiptText, ArrowRight } from '@lucide/astro';
---

<Layout title="Income Calculator" themeColor="bg-emerald-50">
  <main class="md:ml-24 p-4 lg:p-8 max-w-[1200px] mx-auto pb-32">
    
    <header class="bg-white/80 backdrop-blur-md rounded-[2.5rem] p-8 mb-8 border border-white shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="flex items-center gap-4">
        <div class="p-4 bg-emerald-600 text-white rounded-2xl shadow-lg shadow-emerald-200">
          <Banknote size={32} />
        </div>
        <div>
          <h1 class="text-3xl font-black text-slate-900 tracking-tight">Income Estimator</h1>
          <p class="text-slate-500 font-medium">Calculate your take-home pay</p>
        </div>
      </div>
      <div class="text-center md:text-right">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Monthly Take-Home</p>
        <p id="display-net-monthly" class="text-4xl font-black text-emerald-600">$0</p>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <section class="space-y-6">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Wallet class="text-emerald-500" size={20} /> Earnings
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Annual Gross Salary</label>
              <div class="relative">
                <span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                <input 
                  type="number" 
                  id="input-salary" 
                  placeholder="60000" 
                  class="w-full bg-slate-50 border-2 border-transparent focus:border-emerald-500 focus:bg-white p-4 pl-10 rounded-2xl outline-none transition-all font-bold text-lg"
                />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Pay Frequency</label>
                <select id="input-frequency" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-slate-700">
                  <option value="12">Monthly</option>
                  <option value="26">Bi-Weekly</option>
                  <option value="24">Semi-Monthly</option>
                  <option value="52">Weekly</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-400 uppercase mb-2 ml-1">Filing Status</label>
                <select id="input-status" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-slate-700">
                  <option value="single">Single</option>
                  <option value="married">Married</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <button id="btn-push-budget" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] font-black text-lg hover:bg-emerald-600 transition-all flex items-center justify-center gap-3 group shadow-xl">
          Push to Budget Hub <ArrowRight class="group-hover:translate-x-2 transition-transform" />
        </button>
      </section>

      <section class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
        <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
          <ReceiptText class="text-emerald-500" size={20} /> Tax Breakdown
        </h2>
        
        <div class="space-y-6">
          <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
            <span class="text-slate-500 font-bold">Estimated Federal Tax</span>
            <span id="tax-federal" class="font-black text-slate-900">$0</span>
          </div>
          <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
            <span class="text-slate-500 font-bold">FICA (Social Security + Med)</span>
            <span id="tax-fica" class="font-black text-slate-900">$0</span>
          </div>
          <div class="pt-6 border-t border-slate-100">
            <div class="flex justify-between items-center mb-2">
              <span class="text-slate-400 font-bold uppercase text-xs tracking-widest">Effective Tax Rate</span>
              <span id="tax-rate" class="font-black text-emerald-600">0%</span>
            </div>
            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
              <div id="tax-bar" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  import { sync_app, app_data, init_data } from "../utils/financial-data";

  function initIncomePage() {
    init_data();

    const salaryInput = document.getElementById('input-salary') as HTMLInputElement;
    const freqInput = document.getElementById('input-frequency') as HTMLSelectElement;
    const statusInput = document.getElementById('input-status') as HTMLSelectElement;
    const pushBtn = document.getElementById('btn-push-budget');

    // Populate from saved state
    if (app_data.income.user_salary) {
      salaryInput.value = app_data.income.user_salary.toString();
    }

    function calculateTaxes() {
      const gross = parseFloat(salaryInput.value) || 0;
      
      // Simple 2025-style Estimate Logic
      // FICA is 7.65%
      const fica = gross * 0.0765;
      
      // Rough Federal Bracket (Simplified)
      let fed = 0;
      if (gross > 11600) fed += (Math.min(gross, 47150) - 11600) * 0.12;
      if (gross > 47150) fed += (gross - 47150) * 0.22;

      const totalTax = fica + fed;
      const netAnnual = gross - totalTax;
      const netMonthly = netAnnual / 12;

      // Update UI
      document.getElementById('display-net-monthly')!.innerText = `$${Math.round(netMonthly).toLocaleString()}`;
      document.getElementById('tax-federal')!.innerText = `-$${Math.round(fed).toLocaleString()}`;
      document.getElementById('tax-fica')!.innerText = `-$${Math.round(fica).toLocaleString()}`;
      
      const rate = gross > 0 ? (totalTax / gross) * 100 : 0;
      document.getElementById('tax-rate')!.innerText = `${rate.toFixed(1)}%`;
      document.getElementById('tax-bar')!.style.width = `${rate}%`;

      // Sync to Income Data
      sync_app('income.user_salary', gross);
    }

    salaryInput.addEventListener('input', calculateTaxes);
    freqInput.addEventListener('change', calculateTaxes);
    statusInput.addEventListener('change', calculateTaxes);

    pushBtn?.addEventListener('click', () => {
      const gross = parseFloat(salaryInput.value) || 0;
      const fica = gross * 0.0765;
      let fed = 0;
      if (gross > 11600) fed += (Math.min(gross, 47150) - 11600) * 0.12;
      if (gross > 47150) fed += (gross - 47150) * 0.22;
      
      const netMonthly = (gross - (fica + fed)) / 12;

      // PUSH TO BUDGET
      sync_app('budget.net_income', Math.round(netMonthly));
      
      // Visual feedback
      pushBtn.innerText = "âœ“ Pushed to Budget!";
      pushBtn.classList.replace('bg-slate-900', 'bg-emerald-600');
      setTimeout(() => {
        pushBtn.innerText = "Push to Budget Hub";
        pushBtn.classList.replace('bg-emerald-600', 'bg-slate-900');
      }, 2000);
    });

    calculateTaxes();
  }

  initIncomePage();
  document.addEventListener('astro:page-load', initIncomePage);
</script>