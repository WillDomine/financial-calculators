---
import Layout from "../layouts/Layout.astro";
import { Car, Fuel, ShieldAlert, Wrench, ArrowRight, Info, Landmark } from "@lucide/astro";
---

<Layout title="Car Affordability" themeColor="bg-amber-50">
  <main class="md:ml-24 p-4 lg:p-8 max-w-[1200px] mx-auto pb-32">
    
    <header class="bg-white/80 backdrop-blur-md rounded-[2.5rem] p-8 mb-8 border border-white shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="flex items-center gap-4 text-amber-600">
        <div class="p-4 bg-amber-500 text-white rounded-2xl shadow-lg shadow-amber-200">
          <Car size={32} />
        </div>
        <div>
          <h1 class="text-3xl font-black text-slate-900 tracking-tight">Auto Hub</h1>
          <p class="text-slate-500 font-medium">Sticker price to monthly budget</p>
        </div>
      </div>
      <div class="text-center md:text-right">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Estimated Monthly Loan</p>
        <p id="loan-payment-display" class="text-4xl font-black text-amber-600">$0</p>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <section class="space-y-6">
        <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Landmark class="text-amber-500" size={20} /> Loan Details
          </h2>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Car Price</label>
                <input type="number" id="input-price" placeholder="35000" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-lg border-2 border-transparent focus:border-amber-500 focus:bg-white transition-all" />
              </div>
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Down Payment</label>
                <input type="number" id="input-down" placeholder="5000" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-lg border-2 border-transparent focus:border-amber-500 focus:bg-white transition-all" />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Interest Rate (%)</label>
                <input type="number" id="input-rate" step="0.1" placeholder="6.5" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold border-2 border-transparent focus:border-amber-500 focus:bg-white transition-all" />
              </div>
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-2 ml-1">Term (Months)</label>
                <select id="input-term" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-slate-700">
                  <option value="36">36 Months (3yr)</option>
                  <option value="48">48 Months (4yr)</option>
                  <option value="60" selected>60 Months (5yr)</option>
                  <option value="72">72 Months (6yr)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100">
          <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            <Fuel class="text-amber-500" size={20} /> Monthly Upkeep
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Insurance</label>
              <input type="number" id="input-ins" placeholder="180" class="w-full bg-slate-50 p-3 rounded-xl outline-none font-bold text-sm" />
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Gas/Electric</label>
              <input type="number" id="input-gas" placeholder="150" class="w-full bg-slate-50 p-3 rounded-xl outline-none font-bold text-sm" />
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Maint.</label>
              <input type="number" id="input-maint" placeholder="100" class="w-full bg-slate-50 p-3 rounded-xl outline-none font-bold text-sm" />
            </div>
          </div>
        </div>

        <button id="btn-push-car" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] font-black text-lg hover:bg-amber-600 transition-all flex items-center justify-center gap-3 group shadow-xl">
          Push to Budget Needs <ArrowRight class="group-hover:translate-x-2 transition-transform" />
        </button>
      </section>

      <section class="space-y-6">
        <div id="afford-card" class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 flex flex-col justify-center items-center text-center min-h-[300px] transition-all duration-500">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Total Monthly Ownership</p>
            <h2 id="total-cost-display" class="text-6xl font-black text-slate-900 mb-4">$0</h2>
            
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-full mb-8">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-slate-400"></div>
                <span id="afford-status" class="text-xs font-black uppercase text-slate-500 tracking-wider">Calculate Below</span>
            </div>

            <div class="w-full max-w-sm space-y-2">
                <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase">
                    <span>Affordability Meter</span>
                    <span id="afford-ratio">0% of Net Income</span>
                </div>
                <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div id="afford-bar" class="h-full bg-amber-500 transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white relative overflow-hidden">
            <Car class="absolute -bottom-4 -right-4 opacity-10 text-white" size={160} />
            <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                <Info size={18} class="text-amber-400" /> Ownership Tip
            </h3>
            <p class="text-slate-300 text-sm leading-relaxed relative z-10">
                A car is a <b>depreciating asset</b>. Financial experts suggest your total auto costs should stay under <b>10% of your net monthly income</b>. If you are over 15%, you are "Car Poor."
            </p>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  import { sync_app, app_data, init_data } from "../utils/financial-data";

  function setupCarPage() {
    init_data();

    // 1. SELECT & CAST INPUTS
    /** @type {HTMLInputElement} */
    const priceIn = document.getElementById('input-price');
    /** @type {HTMLInputElement} */
    const downIn = document.getElementById('input-down');
    /** @type {HTMLSelectElement} */
    const termIn = document.getElementById('input-term');
    /** @type {HTMLInputElement} */
    const rateIn = document.getElementById('input-rate');
    
    /** @type {HTMLInputElement} */
    const insIn = document.getElementById('input-ins');
    /** @type {HTMLInputElement} */
    const gasIn = document.getElementById('input-gas');
    /** @type {HTMLInputElement} */
    const maintIn = document.getElementById('input-maint');

    // 2. DISPLAY ELEMENTS
    const displayLoan = document.getElementById('loan-payment-display');
    const displayTotal = document.getElementById('total-cost-display');
    const affordStatus = document.getElementById('afford-status');
    const affordBar = document.getElementById('afford-bar');
    const affordRatio = document.getElementById('afford-ratio');
    const statusDot = document.getElementById('status-dot');
    const affordCard = document.getElementById('afford-card');
    const pushBtn = document.getElementById('btn-push-car');

    function calculate() {
      // Get Values Safely
      const price = parseFloat(priceIn?.value || "0");
      const down = parseFloat(downIn?.value || "0");
      const term = parseInt(termIn?.value || "60");
      const annualRate = (parseFloat(rateIn?.value || "6.5")) / 100;
      
      const ins = parseFloat(insIn?.value || "180");
      const gas = parseFloat(gasIn?.value || "150");
      const maint = parseFloat(maintIn?.value || "100");

      // Math: Monthly Loan Payment
      const principal = price - down;
      const monthlyRate = annualRate / 12;
      let loanPayment = 0;

      if (principal > 0 && monthlyRate > 0) {
        loanPayment = (principal * monthlyRate * Math.pow(1 + monthlyRate, term)) / (Math.pow(1 + monthlyRate, term) - 1);
      } else if (principal > 0) {
        loanPayment = principal / term;
      }

      const totalMonthly = loanPayment + ins + gas + maint;

      // Update UI
      if (displayLoan) displayLoan.innerText = `$${Math.round(loanPayment).toLocaleString()}`;
      if (displayTotal) displayTotal.innerText = `$${Math.round(totalMonthly).toLocaleString()}`;

      // AFFORDABILITY CHECK
      const netIncome = app_data.budget.net_income || 0;
      const ratio = netIncome > 0 ? (totalMonthly / netIncome) * 100 : 0;

      if (affordRatio) affordRatio.innerText = `${Math.round(ratio)}% of Net Income`;
      if (affordBar) affordBar.style.width = `${Math.min(ratio * 4, 100)}%`; // Scaled for visual impact

      if (netIncome === 0) {
          updateStatus("Set Income First", "bg-slate-400", "border-slate-100");
      } else if (ratio <= 10) {
          updateStatus("Perfect Fit", "bg-emerald-500", "border-emerald-100 bg-emerald-50/30");
      } else if (ratio <= 15) {
          updateStatus("Moderate", "bg-amber-500", "border-amber-100 bg-amber-50/30");
      } else {
          updateStatus("Too High", "bg-rose-500", "border-rose-100 bg-rose-50/30");
      }

      app_data.car.total_monthly = Math.round(totalMonthly);
    }

    function updateStatus(text, dotColor, cardStyles) {
        if (affordStatus) affordStatus.innerText = text;
        if (statusDot) statusDot.className = `w-2 h-2 rounded-full ${dotColor}`;
        if (affordCard) affordCard.className = `bg-white rounded-[2.5rem] p-8 shadow-sm border flex flex-col justify-center items-center text-center min-h-[300px] transition-all duration-500 ${cardStyles}`;
    }

    // Event Listeners
    [priceIn, downIn, termIn, rateIn, insIn, gasIn, maintIn].forEach(el => {
      el?.addEventListener('input', calculate);
    });

    // Push to Budget
    pushBtn?.addEventListener('click', () => {
        const carTotal = app_data.car.total_monthly || 0;
        const currentNeeds = Array.isArray(app_data.budget.needs) ? app_data.budget.needs : [];
        
        // Use the filter and spread pattern to keep past data
        const otherNeeds = currentNeeds.filter(item => item.name !== "Car Payment");
        const updatedNeeds = [...otherNeeds, { name: "Car Payment", amount: carTotal }];

        app_data.budget.needs = updatedNeeds;
        sync_app('budget.needs', updatedNeeds);

        if (pushBtn) {
            pushBtn.innerText = "âœ“ Added to Budget Hub";
            setTimeout(() => pushBtn.innerText = "Push to Budget Needs", 2000);
        }
    });

    calculate();
  }

  setupCarPage();
  document.addEventListener('astro:page-load', setupCarPage);
</script>